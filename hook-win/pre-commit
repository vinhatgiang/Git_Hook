#!/bin/bash

# Git Hook: pre-commit
# Platform: Git Bash (Windows, macOS, Linux)
# Purpose: Prevent commits to main and develop branches

show_dialog() {
    msg="$1"
    title="$2"
    powershell.exe -WindowStyle Hidden -Command "Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.MessageBox]::Show('$msg', '$title')" > /dev/null
}

current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

if [[ "$current_branch" == "main" ]]; then
    echo
    echo "COMMIT TO MAIN BRANCH BLOCKED"
    echo "You are trying to commit directly to the main branch."
    echo "This action is prohibited for code safety and review process."
    show_dialog "You are trying to commit directly to the main branch.\nThis action is prohibited for code safety.\nPlease:\n1. Create a feature branch\n2. Commit to that branch\n3. Create a Pull Request" "Commit to Main Branch Blocked"
    exit 1
fi

if [[ "$current_branch" == "develop" ]]; then
    echo
    echo "COMMIT TO DEVELOP BRANCH BLOCKED"
    echo "You are trying to commit directly to the develop branch."
    echo "This action is prohibited for development workflow integrity."
    show_dialog "You are trying to commit directly to the develop branch.\nThis action is prohibited for development workflow.\nPlease:\n1. Create a feature branch\n2. Commit to that branch\n3. Create a Pull Request" "Commit to Develop Branch Blocked"
    exit 1
fi

# Check for rebase in progress
if [ -d "$(git rev-parse --git-dir)/rebase-merge" ]; then
    echo
    echo "REBASE OPERATION DETECTED"
    echo "A rebase operation is in progress."
    echo "This action is prohibited for maintaining commit history integrity."
    show_dialog "A rebase operation is in progress.\nThis action is prohibited for maintaining commit history integrity.\nPlease:\n1. Complete or abort the rebase\n2. Resolve any conflicts\n3. Consider using merge instead" "Rebase Operation Detected"
    exit 1
fi

echo "âœ… Pre-commit checks passed"
exit 0

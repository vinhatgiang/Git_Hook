@echo off
setlocal enabledelayedexpansion

REM Git Hook: pre-commit
REM Platform: Windows
REM Purpose: Prevent direct commits to main and develop branches, validate commit messages

REM Get current branch name
for /f "tokens=*" %%i in ('git rev-parse --abbrev-ref HEAD 2^>nul') do set BRANCH=%%i

REM Function to show Windows dialog
set "SHOW_DIALOG=powershell -WindowStyle Hidden -Command "Add-Type -AssemblyName System.Windows.Forms; [System.Windows.Forms.MessageBox]::Show"

REM Function to validate commit message
if exist ".git\COMMIT_EDITMSG" (
    for /f "usebackq delims=" %%i in (".git\COMMIT_EDITMSG") do (
        set "line=%%i"
        if "!line:~0,1!" neq "#" if "!line!" neq "" (
            if not defined COMMIT_MSG set "COMMIT_MSG=!line!"
        )
    )
    
    REM Check minimum length (10 characters)
    set "msg_length=0"
    if defined COMMIT_MSG (
        set "temp_msg=!COMMIT_MSG!"
        :count_loop
        if defined temp_msg (
            set "temp_msg=!temp_msg:~1!"
            set /a msg_length+=1
            goto count_loop
        )
    )
    
    if !msg_length! lss 10 (
        echo.
        echo ❌ COMMIT MESSAGE ERROR
        echo Commit message must be at least 10 characters long.
        echo Current message: '!COMMIT_MSG!' ^(!msg_length! characters^)
        echo.
        echo Commit Message Rules:
        echo • Minimum 10 characters
        echo • Use present tense ^(e.g., 'Add feature' not 'Added feature'^)
        echo • Start with capital letter
        echo • Be descriptive and clear
        echo • Example: 'Add user authentication system'
        
        %SHOW_DIALOG%('Commit message must be at least 10 characters long.\n\nRules:\n• Minimum 10 characters\n• Use present tense\n• Start with capital letter\n• Be descriptive\n\nCurrent: !COMMIT_MSG! (!msg_length! chars)', 'Commit Message Error', 'OK', 'Error')
        
        exit /b 1
    )
    
    REM Check if message starts with capital letter
    set "first_char=!COMMIT_MSG:~0,1!"
    echo !first_char! | findstr /r "^[A-Z]$" >nul
    if errorlevel 1 (
        echo.
        echo ❌ COMMIT MESSAGE ERROR
        echo Commit message must start with a capital letter.
        echo Current message: '!COMMIT_MSG!'
        
        %SHOW_DIALOG%('Commit message must start with a capital letter.\n\nCurrent: !COMMIT_MSG!', 'Commit Message Error', 'OK', 'Error')
        
        exit /b 1
    )
)

REM Check if committing to protected branches
if "%BRANCH%"=="main" (
    echo.
    echo ❌ COMMIT TO MAIN BRANCH BLOCKED
    echo You are trying to commit directly to the '%BRANCH%' branch.
    echo This action is prohibited for code safety and review process.
    echo.
    echo Recommended workflow:
    echo 1. Create a feature branch: git checkout -b feature/your-feature
    echo 2. Make your changes and commit
    echo 3. Push the branch: git push origin feature/your-feature
    echo 4. Create a Pull Request for code review
    
    %SHOW_DIALOG%('You are trying to commit directly to the main branch.\n\nThis action is prohibited for code safety.\n\nPlease:\n1. Create a feature branch\n2. Make changes there\n3. Create a Pull Request', 'Direct Commit to Main Branch Blocked', 'OK', 'Error')
    
    exit /b 1
)

if "%BRANCH%"=="master" (
    echo.
    echo ❌ COMMIT TO MASTER BRANCH BLOCKED
    echo You are trying to commit directly to the '%BRANCH%' branch.
    echo This action is prohibited for code safety and review process.
    echo.
    echo Recommended workflow:
    echo 1. Create a feature branch: git checkout -b feature/your-feature
    echo 2. Make your changes and commit
    echo 3. Push the branch: git push origin feature/your-feature
    echo 4. Create a Pull Request for code review
    
    %SHOW_DIALOG%('You are trying to commit directly to the master branch.\n\nThis action is prohibited for code safety.\n\nPlease:\n1. Create a feature branch\n2. Make changes there\n3. Create a Pull Request', 'Direct Commit to Master Branch Blocked', 'OK', 'Error')
    
    exit /b 1
)

if "%BRANCH%"=="develop" (
    echo.
    echo ❌ COMMIT TO DEVELOP BRANCH BLOCKED
    echo You are trying to commit directly to the '%BRANCH%' branch.
    echo This action is prohibited for development workflow integrity.
    echo.
    echo Recommended workflow:
    echo 1. Create a feature branch: git checkout -b feature/your-feature
    echo 2. Make your changes and commit
    echo 3. Push the branch: git push origin feature/your-feature
    echo 4. Create a Pull Request to merge into develop
    
    %SHOW_DIALOG%('You are trying to commit directly to the develop branch.\n\nThis action is prohibited for development workflow.\n\nPlease:\n1. Create a feature branch\n2. Make changes there\n3. Create a Pull Request', 'Direct Commit to Develop Branch Blocked', 'OK', 'Error')
    
    exit /b 1
)

if "%BRANCH%"=="dev" (
    echo.
    echo ❌ COMMIT TO DEV BRANCH BLOCKED
    echo You are trying to commit directly to the '%BRANCH%' branch.
    echo This action is prohibited for development workflow integrity.
    echo.
    echo Recommended workflow:
    echo 1. Create a feature branch: git checkout -b feature/your-feature
    echo 2. Make your changes and commit
    echo 3. Push the branch: git push origin feature/your-feature
    echo 4. Create a Pull Request to merge into develop
    
    %SHOW_DIALOG%('You are trying to commit directly to the dev branch.\n\nThis action is prohibited for development workflow.\n\nPlease:\n1. Create a feature branch\n2. Make changes there\n3. Create a Pull Request', 'Direct Commit to Dev Branch Blocked', 'OK', 'Error')
    
    exit /b 1
)

echo ✅ Pre-commit checks passed for branch: %BRANCH%
exit /b 0